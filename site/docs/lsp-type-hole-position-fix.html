<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSP Type Hole Code Action Position Fix - Cure Documentation</title>
    <meta name="description" content=" Problem
Code actions for type holes were inserting the inferred type at the wrong position, resulting in malformed code:">
    <link rel="icon" type="image/png" href="../media/logo-128x128.png">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="nav-container">
            <div class="logo-section">
                <img src="../media/logo-128x128.png" alt="Cure Logo" class="logo">
                <div>
                    <h1 class="site-title">Cure</h1>
                    <p class="site-tagline">Verification-First Programming</p>
                </div>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="../docs.html">Documentation</a></li>
                    <li><a href="../api/index.html">API Reference</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="doc-page">
        <div class="doc-nav">
            <a href="../docs.html">← Back to Documentation</a>
        </div>
        
        <h1 id="lsp-type-hole-code-action-position-fix">LSP Type Hole Code Action Position Fix</h1>
<h2 id="problem">Problem</h2>
<p>Code actions for type holes were inserting the inferred type at the wrong position, resulting in malformed code:</p>
<p><strong>Before fix:</strong></p>
<div class="codehilite"><pre><span></span><code>def process_data(xs: List(Int)): _ =
</code></pre></div>

<p><strong>After applying code action (WRONG):</strong></p>
<div class="codehilite"><pre><span></span><code>def process_data(xs: List(Int)): _ =List(Int)
</code></pre></div>

<p>The type was being inserted <strong>after</strong> the <code>=</code> instead of <strong>replacing</strong> the <code>_</code>.</p>
<h2 id="root-cause">Root Cause</h2>
<p>In <code>create_fill_hole_action</code> (lines 579-620 in <code>cure_lsp_type_holes.erl</code>), the code was using a "rough estimate" to calculate the underscore position:</p>
<div class="codehilite"><pre><span></span><code><span class="c">% OLD CODE (incorrect)</span>
<span class="nv">UnderscoreChar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">StartChar</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w">  </span><span class="c">% Rough estimate</span>
<span class="nv">ActualRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">#{</span>
<span class="w">    </span><span class="n">start</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">#{</span><span class="n">line</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">StartLine</span><span class="p">,</span><span class="w"> </span><span class="n">character</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">UnderscoreChar</span><span class="p">},</span>
<span class="w">    </span><span class="n">&#39;end&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">#{</span><span class="n">line</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">StartLine</span><span class="p">,</span><span class="w"> </span><span class="n">character</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">UnderscoreChar</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span>
<span class="p">},</span>
</code></pre></div>

<h3 id="why-this-was-wrong">Why This Was Wrong</h3>
<ol>
<li>The diagnostic range is created as <code>(Col - 1)</code> to <code>(Col + 10)</code> where <code>Col</code> is the 1-indexed parser column</li>
<li>This converts to 0-indexed LSP coordinates: <code>StartChar = Col - 1</code></li>
<li>So <code>StartChar</code> is <strong>already</strong> the correct 0-indexed position of the underscore</li>
<li>Adding 4 to it (<code>StartChar + 4</code>) was shifting the replacement position 4 characters too far right</li>
</ol>
<h3 id="example">Example</h3>
<p>For line <code>def double_list(numbers: List(Int)): _ =</code>:<br />
- Parser reports <code>Col = 40</code> (1-indexed)<br />
- Diagnostic creates <code>StartChar = 39</code> (0-indexed LSP coordinate)<br />
- <strong>Incorrect calculation</strong>: <code>UnderscoreChar = 39 + 4 = 43</code> ❌<br />
  - Position 43 is the space after <code>=</code><br />
  - Results in: <code>): _ =List(Int)</code><br />
- <strong>Correct position</strong>: <code>39</code> ✅<br />
  - Position 39 is the <code>_</code><br />
  - Results in: <code>): List(Int) =</code></p>
<h2 id="solution">Solution</h2>
<p>Removed the incorrect <code>+4</code> offset and used <code>StartChar</code> directly:</p>
<div class="codehilite"><pre><span></span><code><span class="c">% NEW CODE (correct)</span>
<span class="c">% The diagnostic range was created as (Col-1) to (Col+10) in 0-indexed LSP coordinates</span>
<span class="c">% where Col is the 1-indexed parser column of the underscore.</span>
<span class="c">% So StartChar is already the correct 0-indexed position of the underscore.</span>
<span class="c">% We want to replace exactly one character: the underscore itself.</span>
<span class="nv">ActualRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">#{</span>
<span class="w">    </span><span class="n">start</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">#{</span><span class="n">line</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">StartLine</span><span class="p">,</span><span class="w"> </span><span class="n">character</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">StartChar</span><span class="p">},</span>
<span class="w">    </span><span class="n">&#39;end&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">#{</span><span class="n">line</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">StartLine</span><span class="p">,</span><span class="w"> </span><span class="n">character</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">StartChar</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span>
<span class="p">},</span>
</code></pre></div>

<h2 id="files-modified">Files Modified</h2>
<ul>
<li><code>/opt/Proyectos/Ammotion/cure/lsp/cure_lsp_type_holes.erl</code> (lines 589-602)</li>
<li>Removed incorrect <code>UnderscoreChar = StartChar + 4</code> calculation</li>
<li>Changed <code>ActualRange</code> to use <code>StartChar</code> directly</li>
</ul>
<h2 id="verification">Verification</h2>
<h3 id="test-output-before-fix">Test Output Before Fix</h3>
<div class="codehilite"><pre><span></span><code><span class="nv">Diagnostic</span><span class="w"> </span><span class="nv">range</span>:<span class="w"> </span><span class="nv">start</span><span class="o">=</span><span class="mi">39</span>,<span class="w"> </span><span class="k">end</span><span class="o">=</span><span class="mi">50</span>
<span class="nv">Replacement</span><span class="w"> </span><span class="nv">range</span>:<span class="w"> </span><span class="nv">start</span><span class="o">=</span><span class="mi">43</span>,<span class="w"> </span><span class="k">end</span><span class="o">=</span><span class="mi">44</span><span class="w">  </span>❌<span class="w"> </span><span class="ss">(</span><span class="mi">4</span><span class="w"> </span><span class="nv">characters</span><span class="w"> </span><span class="nv">off</span><span class="ss">)</span>
</code></pre></div>

<h3 id="test-output-after-fix">Test Output After Fix</h3>
<div class="codehilite"><pre><span></span><code><span class="nv">Diagnostic</span><span class="w"> </span><span class="nv">range</span>:<span class="w"> </span><span class="nv">start</span><span class="o">=</span><span class="mi">39</span>,<span class="w"> </span><span class="k">end</span><span class="o">=</span><span class="mi">50</span>
<span class="nv">Replacement</span><span class="w"> </span><span class="nv">range</span>:<span class="w"> </span><span class="nv">start</span><span class="o">=</span><span class="mi">39</span>,<span class="w"> </span><span class="k">end</span><span class="o">=</span><span class="mi">40</span><span class="w">  </span>✅<span class="w"> </span><span class="ss">(</span><span class="nv">correct</span><span class="o">!</span><span class="ss">)</span>
</code></pre></div>

<h3 id="character-position-verification">Character Position Verification</h3>
<div class="codehilite"><pre><span></span><code><span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  def double_list(numbers: List(Int)): _ =&#39;</span>
<span class="c1">#       0123456789012345678901234567890123456789012</span>
<span class="c1">#                 1111111111222222222233333333334444</span>

<span class="n">line</span><span class="p">[</span><span class="mi">39</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span>  <span class="c1"># True ✅</span>
</code></pre></div>

<h2 id="result">Result</h2>
<p>Now when applying the code action:</p>
<p><strong>Before:</strong></p>
<div class="codehilite"><pre><span></span><code>def double_list(numbers: List(Int)): _ =
</code></pre></div>

<p><strong>After (correct):</strong></p>
<div class="codehilite"><pre><span></span><code>def double_list(numbers: List(Int)): List(Int) =
</code></pre></div>

<p>The type hole <code>_</code> is correctly replaced with the inferred type <code>List(Int)</code>.</p>
<h2 id="related-fixes">Related Fixes</h2>
<p>This completes the type hole code action implementation, building on:<br />
1. Remote call type inference implementation<br />
2. Diagnostic location tracking fix (<code>LSP_TYPE_HOLE_CODE_ACTION_FIX.md</code>)<br />
3. Makefile fix for LSP compilation (<code>MAKE_LSP_FIX.md</code>)</p>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>Documentation</h4>
                <ul>
                    <li><a href="../docs.html">Getting Started</a></li>
                    <li><a href="language-spec.html">Language Specification</a></li>
                    <li><a href="type-system.html">Type System</a></li>
                    <li><a href="fsm-usage.html">FSM Guide</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h4>Reference</h4>
                <ul>
                    <li><a href="../api/index.html">API Reference</a></li>
                    <li><a href="std-summary.html">Standard Library</a></li>
                    <li><a href="feature-reference.html">Feature Reference</a></li>
                    <li><a href="cli-usage.html">CLI Usage</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h4>Resources</h4>
                <ul>
                    <li><a href="editor-setup.html">Editor Setup</a></li>
                    <li><a href="project-overview.html">Project Overview</a></li>
                    <li><a href="cure-ultimate-description.html">Ultimate Guide</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p>&copy; 2025 Cure Programming Language. Verification-first programming for the BEAM.</p>
        </div>
    </footer>
</body>
</html>
