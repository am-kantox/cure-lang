<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSP Type Hole Remote Call Inference Fix - Cure Documentation</title>
    <meta name="description" content=" Problem">
    <link rel="icon" type="image/png" href="../media/logo-128x128.png">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="nav-container">
            <div class="logo-section">
                <img src="../media/logo-128x128.png" alt="Cure Logo" class="logo">
                <div>
                    <h1 class="site-title">Cure</h1>
                    <p class="site-tagline">Verification-First Programming</p>
                </div>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="../docs.html">Documentation</a></li>
                    <li><a href="../api/index.html">API Reference</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="doc-page">
        <div class="doc-nav">
            <a href="../docs.html">‚Üê Back to Documentation</a>
        </div>
        
        <h1 id="lsp-type-hole-remote-call-inference-fix">LSP Type Hole Remote Call Inference Fix</h1>
<h2 id="problem">Problem</h2>
<p>The LSP was unable to infer types for functions that use imported functions (remote calls) in their body when using type holes (<code>_</code>). For example:</p>
<div class="codehilite"><pre><span></span><code><span class="n">module</span><span class="w"> </span><span class="n">TypeHolesDemo</span><span class="w"> </span><span class="n">do</span>
<span class="w">  </span><span class="kn">import</span><span class="w"> </span><span class="nn">Std.List</span><span class="w"> </span><span class="p">[</span><span class="nb">map</span><span class="p">,</span><span class="w"> </span><span class="nb">filter</span><span class="p">]</span>

<span class="w">  </span><span class="c1"># LSP showed &quot;Cannot infer type&quot; for this:</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">double_list</span><span class="p">(</span><span class="n">numbers</span><span class="p">:</span><span class="w"> </span><span class="nb">List</span><span class="p">(</span><span class="nb">Int</span><span class="p">)):</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nb">map</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span><span class="w"> </span><span class="n">fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">end</span><span class="p">)</span>
<span class="n">end</span>
</code></pre></div>

<p>The compiler worked fine, but the LSP couldn't infer that the return type should be <code>List(Int)</code>.</p>
<h2 id="root-cause">Root Cause</h2>
<p>The LSP's type hole inference module (<code>lsp/cure_lsp_type_holes.erl</code>) had its own simplified type inference that:</p>
<ol>
<li><strong>Didn't process imports</strong>: The simple <code>infer_expr_type/1</code> function didn't build a proper environment with imported functions</li>
<li><strong>Had hardcoded special cases</strong>: Only <code>map</code> was special-cased, and even that was limited</li>
<li><strong>Didn't use the real type checker</strong>: Instead of leveraging <code>cure_typechecker:infer_type/2</code>, it reimplemented a subset of type inference</li>
</ol>
<h2 id="solution">Solution</h2>
<p>Updated <code>lsp/cure_lsp_type_holes.erl</code> to use the full Cure type checker:</p>
<h3 id="1-build-proper-type-environment">1. Build Proper Type Environment</h3>
<div class="codehilite"><pre><span></span><code><span class="nf">build_module_env</span><span class="p">(</span><span class="nv">AST</span><span class="p">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="nb">is_list</span><span class="p">(</span><span class="nv">AST</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="nv">BaseEnv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">cure_typechecker</span><span class="p">:</span><span class="nf">builtin_env</span><span class="p">(),</span>
<span class="w">    </span><span class="c">% Find import definitions in the AST</span>
<span class="w">    </span><span class="nv">Imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">Item</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="nv">Item</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nv">AST</span><span class="p">,</span><span class="w"> </span><span class="nb">is_record</span><span class="p">(</span><span class="nv">Item</span><span class="p">,</span><span class="w"> </span><span class="n">import_def</span><span class="p">)],</span>
<span class="w">    </span><span class="c">% Process imports to extend environment</span>
<span class="w">    </span><span class="n">process_imports_for_env</span><span class="p">(</span><span class="nv">Imports</span><span class="p">,</span><span class="w"> </span><span class="nv">BaseEnv</span><span class="p">).</span>
</code></pre></div>

<h3 id="2-process-imports">2. Process Imports</h3>
<div class="codehilite"><pre><span></span><code><span class="nf">import_single_item</span><span class="p">(</span><span class="nv">Module</span><span class="p">,</span><span class="w"> </span><span class="nl">#function_import</span><span class="p">{</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Name</span><span class="p">,</span><span class="w"> </span><span class="n">arity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Arity</span><span class="p">},</span><span class="w"> </span><span class="nv">Env</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="c">% Use cure_typechecker&#39;s function to get the imported function type</span>
<span class="w">    </span><span class="nv">FunctionType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">cure_typechecker</span><span class="p">:</span><span class="nf">create_imported_function_type</span><span class="p">(</span><span class="nv">Module</span><span class="p">,</span><span class="w"> </span><span class="nv">Name</span><span class="p">,</span><span class="w"> </span><span class="nv">Arity</span><span class="p">),</span>
<span class="w">    </span><span class="nv">NewEnv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">cure_types</span><span class="p">:</span><span class="nf">extend_env</span><span class="p">(</span><span class="nv">Env</span><span class="p">,</span><span class="w"> </span><span class="nv">Name</span><span class="p">,</span><span class="w"> </span><span class="nv">FunctionType</span><span class="p">),</span>
<span class="w">    </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">NewEnv</span><span class="p">}.</span>
</code></pre></div>

<p>This leverages <code>cure_stdlib_signatures</code> to get the exact type signatures for imported functions like:<br />
- <code>map: (List(T), T =&gt; U) -&gt; List(U)</code><br />
- <code>filter: (List(T), T =&gt; Bool) -&gt; List(T)</code></p>
<h3 id="3-use-full-type-checker">3. Use Full Type Checker</h3>
<div class="codehilite"><pre><span></span><code><span class="nf">infer_function_return_type</span><span class="p">(</span><span class="nl">#function_def</span><span class="p">{</span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Body</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Params</span><span class="p">},</span><span class="w"> </span><span class="nv">AST</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">build_module_env</span><span class="p">(</span><span class="nv">AST</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">        </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Env</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="nv">EnvWithParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add_params_to_env</span><span class="p">(</span><span class="nv">Params</span><span class="p">,</span><span class="w"> </span><span class="nv">Env</span><span class="p">),</span>
<span class="w">            </span><span class="c">% Use cure_typechecker to infer the body type</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nn">cure_typechecker</span><span class="p">:</span><span class="nf">infer_type</span><span class="p">(</span><span class="nv">Body</span><span class="p">,</span><span class="w"> </span><span class="nv">EnvWithParams</span><span class="p">)</span><span class="w"> </span><span class="k">of</span>
<span class="w">                </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">Type</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span>
<span class="w">                    </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="n">convert_type_to_ast_format</span><span class="p">(</span><span class="nv">Type</span><span class="p">)};</span>
<span class="w">                </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="p">_}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span>
<span class="w">                    </span><span class="nv">Error</span>
<span class="w">            </span><span class="k">end</span><span class="p">;</span>
<span class="w">        </span><span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="p">_}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Error</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="nv">Error</span>
<span class="w">    </span><span class="k">end</span><span class="p">.</span>
</code></pre></div>

<h3 id="4-convert-types">4. Convert Types</h3>
<p>Added <code>convert_type_to_ast_format/1</code> to convert from the type checker's internal representation to the AST format expected by the LSP:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">convert_type_to_ast_format</span><span class="p">({</span><span class="n">list_type</span><span class="p">,</span><span class="w"> </span><span class="nv">ElemType</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="nv">Length</span><span class="p">})</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="nl">#dependent_type</span><span class="p">{</span>
<span class="w">        </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">&#39;List&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="n">type_params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">convert_type_to_ast_format</span><span class="p">(</span><span class="nv">ElemType</span><span class="p">)],</span>
<span class="w">        </span><span class="n">value_params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">undefined</span>
<span class="w">    </span><span class="p">}.</span>
</code></pre></div>

<h2 id="benefits">Benefits</h2>
<ol>
<li><strong>Complete Coverage</strong>: Works for all imported functions, not just hardcoded cases</li>
<li><strong>Consistency</strong>: LSP and compiler use the same type inference logic</li>
<li><strong>Future-Proof</strong>: Automatically supports new standard library functions</li>
<li><strong>Accurate</strong>: Uses the same constraint solving and unification as the compiler</li>
</ol>
<h2 id="testing">Testing</h2>
<p>The fix has been tested with:</p>
<ol>
<li><strong>Basic remote calls</strong>: <code>map(numbers, fn(x) -&gt; x * 2 end)</code> correctly infers <code>List(Int)</code></li>
<li><strong>Multiple imports</strong>: Both <code>map</code> and <code>filter</code> work correctly</li>
<li><strong>Chained operations</strong>: Combining multiple imported functions works</li>
<li><strong>Type holes</strong>: Both return type holes and parameter type holes are supported</li>
</ol>
<h2 id="files-changed">Files Changed</h2>
<ul>
<li><code>lsp/cure_lsp_type_holes.erl</code>: Main implementation</li>
<li>Added <code>build_module_env/1</code> to build environment with imports</li>
<li>Added <code>process_imports_for_env/2</code> to process import statements</li>
<li>Added <code>import_single_item/3</code> to add imported functions to environment</li>
<li>Added <code>add_params_to_env/2</code> to add parameters to environment</li>
<li>Added <code>convert_type_to_ast_format/1</code> for type conversion</li>
<li>Updated <code>infer_function_return_type/2</code> to use full type checker</li>
</ul>
<h2 id="related">Related</h2>
<ul>
<li>Compiler already had correct implementation in <code>src/types/cure_typechecker.erl</code></li>
<li>Type signatures in <code>src/types/cure_stdlib_signatures.erl</code> are shared between compiler and LSP</li>
<li>No changes needed to the core type system</li>
</ul>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>Documentation</h4>
                <ul>
                    <li><a href="../docs.html">Getting Started</a></li>
                    <li><a href="language-spec.html">Language Specification</a></li>
                    <li><a href="type-system.html">Type System</a></li>
                    <li><a href="fsm-usage.html">FSM Guide</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h4>Reference</h4>
                <ul>
                    <li><a href="../api/index.html">API Reference</a></li>
                    <li><a href="std-summary.html">Standard Library</a></li>
                    <li><a href="feature-reference.html">Feature Reference</a></li>
                    <li><a href="cli-usage.html">CLI Usage</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h4>Resources</h4>
                <ul>
                    <li><a href="editor-setup.html">Editor Setup</a></li>
                    <li><a href="project-overview.html">Project Overview</a></li>
                    <li><a href="cure-ultimate-description.html">Ultimate Guide</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p>&copy; 2025 Cure Programming Language. Verification-first programming for the BEAM.</p>
        </div>
    </footer>
</body>
</html>
